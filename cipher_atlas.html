<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cipher Atlas - Steganography Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --input-bg: #020617;
            --accent: #38bdf8; /* Sky Blue */
            --accent-glow: #38bdf8;
            --accent-dim: rgba(56, 189, 248, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        body { 
            font-family: 'Playfair Display', serif; 
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(to right, rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-main); 
        }

        .atlas-title { font-family: 'Cinzel', serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .sidebar-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Distinct Card Style */
        .atlas-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .section-header {
            background: rgba(0,0,0,0.3);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            font-weight: 900; /* Bold for clarity */
            letter-spacing: 0.1em;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.4); /* Glow effect */
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .tab-btn { 
            transition: all 0.3s; 
            font-family: 'Cinzel', serif;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 700;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover { color: var(--accent); text-shadow: 0 0 8px var(--accent-dim); }
        .tab-btn.active { 
            color: var(--accent); 
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.6);
            border-bottom: 2px solid var(--accent);
        }

        #canvas-wrapper { 
            position: relative; 
            display: inline-block; 
            cursor: crosshair;
            border: 4px solid var(--panel-bg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); 
            border-radius: 4px;
        }

        canvas { 
            background: #94a3b8; 
            max-width: 100%; 
            height: auto; 
            filter: contrast(1.1) grayscale(0.1);
            display: block;
        }

        /* Marker */
        .treasure-spot { 
            position: absolute; 
            width: 24px; 
            height: 24px; 
            transform: translate(-50%, -50%); 
            pointer-events: none; 
            border: 2px solid var(--accent);
            border-radius: 50%;
            background: var(--accent-dim);
            box-shadow: 0 0 15px var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .treasure-spot::after {
            content: '';
            width: 4px;
            height: 4px;
            background-color: var(--accent);
            border-radius: 50%;
        }

        .revealed-msg { 
            position: absolute; 
            background: #0f172a; 
            border: 1px solid var(--accent); 
            padding: 1.25rem; 
            border-radius: 6px; 
            font-weight: 500; 
            color: #ffffff; 
            transform: translate(-50%, -115%); 
            box-shadow: 0 10px 40px rgba(0,0,0,1); 
            z-index: 100; 
            pointer-events: auto; 
            min-width: 280px;
            text-align: center;
            animation: popUp 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Smart Positioning Logic */
        .revealed-msg.msg-left { transform: translate(15px, -115%) !important; text-align: left; }
        .revealed-msg.msg-right { transform: translate(calc(-100% - 15px), -115%) !important; text-align: right; }
        
        .revealed-msg.msg-bottom { transform: translate(-50%, 25px) !important; }
        .revealed-msg.msg-left.msg-bottom { transform: translate(15px, 25px) !important; }
        .revealed-msg.msg-right.msg-bottom { transform: translate(calc(-100% - 15px), 25px) !important; }
        
        .revealed-msg img {
            display: block;
            max-width: 100%;
            max-height: 200px;
            margin: 0.75rem auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: zoom-in;
            background: #000;
        }

        .btn-atlas {
            background: var(--accent);
            color: #0f172a;
            border: none;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            letter-spacing: 0.1em;
            transition: all 0.2s;
        }
        .btn-atlas:hover {
            background: #7dd3fc;
            box-shadow: 0 0 15px var(--accent-dim);
        }
        .btn-atlas-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .btn-atlas-outline:hover {
            background: var(--accent-dim);
        }

        .input-group label {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            font-weight: 700;
        }

        /* Enhanced Inputs */
        .atlas-input {
            width: 100%;
            background: var(--input-bg) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-main) !important;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            transition: border-color 0.2s;
        }
        .atlas-input:focus {
            border-color: var(--accent) !important;
            outline: none;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.2);
        }
        .atlas-input::placeholder { color: #475569; }

        /* File Upload Area */
        #drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            transition: all 0.2s;
            background: rgba(0,0,0,0.1);
        }
        #drop-zone:hover, #drop-zone.drag-over {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        /* List Items */
        .log-item {
            background: rgba(0,0,0,0.2);
            border-left: 2px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        .log-item:hover {
            background: var(--accent-dim);
            border-left-color: var(--accent);
            color: var(--text-main);
        }

        @keyframes popUp {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .processing { pointer-events: none; opacity: 0.7; filter: grayscale(1); }

        #image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #image-modal.active { opacity: 1; pointer-events: auto; }
        #modal-img {
            max-width: 90vw;
            max-height: 90vh;
            border: 2px solid var(--accent);
            border-radius: 4px;
            box-shadow: 0 0 50px rgba(56, 189, 248, 0.2);
        }
        .close-modal {
            position: absolute;
            top: 2rem;
            right: 2rem;
            color: var(--text-muted);
            font-size: 2rem;
            cursor: pointer;
        }
        .close-modal:hover { color: var(--accent); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <header class="text-center mb-10 w-full max-w-7xl flex flex-col items-center relative z-10">
        <div class="flex items-center gap-4 mb-2">
            <div class="w-12 h-12 rounded bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 flex items-center justify-center text-[#38bdf8] text-2xl shadow-lg">
                <i class="fas fa-atlas"></i>
            </div>
            <h1 class="atlas-title text-4xl font-bold text-slate-100 tracking-wider">CIPHER ATLAS</h1>
        </div>
        <p class="text-xs font-bold text-slate-500 uppercase tracking-[0.3em] font-mono">Secure Steganography Protocol</p>
    </header>

    <nav class="flex gap-8 mb-8 relative z-10 bg-slate-900/50 p-2 rounded-full border border-slate-800 backdrop-blur-sm">
        <button onclick="setTab('bake')" id="tab-bake" class="tab-btn active px-6 py-2 flex items-center gap-2 rounded-full">
            <i class="fas fa-layer-group"></i> Conceal
        </button>
        <button onclick="setTab('reveal')" id="tab-reveal" class="tab-btn px-6 py-2 flex items-center gap-2 rounded-full">
            <i class="fas fa-unlock-alt"></i> Decipher
        </button>
    </nav>

    <main class="w-full max-w-[1400px] grid grid-cols-1 lg:grid-cols-12 gap-8 relative z-10">
        <!-- Sidebar -->
        <aside class="lg:col-span-4 sidebar-container h-fit">
            
            <!-- Card 1: Map Source -->
            <div class="atlas-card">
                <div class="section-header">
                    <i class="fas fa-map"></i> Source Document
                </div>
                <div class="p-5">
                    <input type="file" id="pdf-input" accept="application/pdf" class="hidden">
                    <label for="pdf-input" id="drop-zone" class="w-full py-8 flex flex-col items-center justify-center cursor-pointer group">
                        <i class="fas fa-file-pdf text-3xl text-slate-600 mb-3 group-hover:text-[#38bdf8] transition-colors"></i>
                        <span id="file-name" class="text-xs text-slate-400 text-center px-4 font-mono group-hover:text-slate-200">
                            Select PDF Cover<br>
                            <span class="opacity-50 text-[10px]">(Max 20MB)</span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Panel 2: Bake Inputs (Visible only in Bake tab) -->
            <div id="bake-inputs" class="flex flex-col gap-6">
                <!-- Log Card -->
                <div class="atlas-card">
                    <div class="section-header justify-between">
                        <span><i class="fas fa-list"></i> Cipher Log</span>
                        <span id="count-display" class="text-[0.65rem] bg-[#38bdf8] text-[#0f172a] px-2 py-0.5 rounded font-bold shadow-lg shadow-sky-500/20">0 ITEMS</span>
                    </div>
                    <div class="p-4 bg-[#0f172a]">
                        <div id="treasure-list" class="h-24 overflow-y-auto pr-1">
                            <div class="text-center text-[0.65rem] text-slate-600 italic py-8">No sigils placed yet.</div>
                        </div>
                    </div>
                </div>

                <!-- Input Form Card -->
                <div class="atlas-card border-t-4 border-t-[#38bdf8]">
                    <div class="section-header">
                        <i class="fas fa-pen-fancy"></i> New Entry
                    </div>
                    <div class="p-5 flex flex-col gap-4">
                        
                        <div class="input-group">
                            <div class="flex justify-between items-center mb-1">
                                <label>Secret Intelligence</label>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="quick-mode" class="accent-[#38bdf8] w-3 h-3 cursor-pointer">
                                    <label for="quick-mode" class="cursor-pointer !mb-0 !text-[0.6rem] text-[#38bdf8] !font-bold">Quick Add</label>
                                </div>
                            </div>
                            <textarea id="secret-message" placeholder="Enter confidential text..." class="atlas-input h-20 resize-none"></textarea>
                        </div>

                        <div class="input-group">
                            <label>Attachment (Optional)</label>
                            <div class="relative">
                                <input type="file" id="treasure-file" class="hidden" accept="image/*, audio/*, .xlsx, .xls, .csv, .txt, .pdf">
                                <label for="treasure-file" class="atlas-input flex items-center justify-between cursor-pointer hover:border-[#38bdf8] group">
                                    <span id="attach-label" class="text-slate-500 truncate">Choose File...</span>
                                    <i class="fas fa-paperclip text-slate-600 group-hover:text-[#38bdf8]"></i>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-1">
                            <div class="input-group">
                                <label>Encryption PIN</label>
                                <input type="number" id="bake-key" placeholder="1234" class="atlas-input text-center tracking-widest font-bold text-[#38bdf8]">
                            </div>
                            <div class="flex items-end">
                                <button onclick="addTreasurePoint()" class="w-full btn-atlas-outline py-[0.7rem] rounded h-[42px] uppercase font-bold text-xs hover:bg-[#38bdf8] hover:text-[#0f172a]">
                                    <i class="fas fa-plus"></i> Add Sigil
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Main Action Button -->
                <button id="bake-btn" onclick="bakeTreasure(this)" class="w-full btn-atlas py-4 rounded shadow-lg shadow-sky-900/20 text-sm uppercase tracking-widest">
                    Encrypt & Seal Atlas
                </button>
            </div>

            <!-- Panel 3: Reveal Inputs (Visible only in Reveal tab) -->
            <div id="reveal-inputs" class="hidden flex flex-col gap-6">
                <div id="scan-status" class="hidden p-4 rounded bg-slate-800/50 border border-slate-700 text-xs font-mono text-center"></div>
                
                <div class="atlas-card p-8 flex flex-col gap-6 items-center text-center">
                    <div class="w-16 h-16 rounded-full bg-[#0f172a] border border-slate-700 flex items-center justify-center text-[#38bdf8] text-2xl shadow-[0_0_15px_rgba(56,189,248,0.2)]">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    
                    <div class="w-full">
                        <label class="block font-mono text-xs text-slate-400 mb-2 uppercase font-bold">Decryption PIN</label>
                        <input type="number" id="reveal-key" placeholder="Enter PIN" class="atlas-input text-center text-xl tracking-[0.5em] py-4">
                    </div>

                    <div class="text-xs text-slate-500 font-mono leading-relaxed">
                        Authenticate to reveal hidden layers.<br>
                        Click any <span class="text-[#38bdf8] font-bold">Blue Sigil</span> on the map.
                    </div>
                </div>
            </div>

        </aside>

        <!-- Main Map Area -->
        <article class="lg:col-span-8 bg-[#020617] rounded-lg border border-slate-800 p-1 flex items-center justify-center min-h-[600px] shadow-2xl relative overflow-visible group">
            <!-- Grid Background for Map Area -->
            <div class="absolute inset-0 opacity-10 pointer-events-none" 
                 style="background-image: linear-gradient(#38bdf8 1px, transparent 1px), linear-gradient(90deg, #38bdf8 1px, transparent 1px); background-size: 50px 50px;">
            </div>
            
            <div id="preview-container" class="relative z-10 p-4 w-full h-full flex items-center justify-center overflow-auto">
                <div id="canvas-wrapper">
                    <canvas id="pdf-canvas"></canvas>
                    <div id="overlay-layer"></div>
                </div>
                
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <i class="fas fa-globe-americas text-6xl text-slate-800 mb-4"></i>
                    <div class="text-slate-700 font-black uppercase tracking-[0.5em] text-sm font-mono">
                        Awaiting Projection
                    </div>
                </div>
            </div>
        </article>
    </main>

    <div id="image-modal" onclick="closeModal()">
        <span class="close-modal">&times;</span>
        <img id="modal-img" src="" alt="Enlarged Artifact">
    </div>

    <script>
        const PAYLOAD_SEPARATOR = "%%ENIGMA_ARCHIVES_PAYLOAD_V1%%";
        let currentTab = 'bake';
        let pdfBytes = null; 
        let selectedX = 0, selectedY = 0; 
        let tempPoints = []; 
        let bakedDataArray = []; 
        let globalZIndex = 100;

        try {
             if (typeof pdfjsLib !== 'undefined') {
                const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
                fetch(workerUrl).then(resp => resp.text()).then(data => {
                    try { const blob = new Blob([data], { type: "text/javascript" }); pdfjsLib.GlobalWorkerOptions.workerSrc = URL.createObjectURL(blob); } catch(e) {}
                }).catch(() => {});
            }
        } catch (e) { console.error("Worker Setup Error:", e); }

        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeTab = document.getElementById(`tab-${tab}`);
            if (activeTab) activeTab.classList.add('active');
            
            document.getElementById('bake-inputs').classList.toggle('hidden', tab !== 'bake');
            document.getElementById('reveal-inputs').classList.toggle('hidden', tab !== 'reveal');
            document.getElementById('overlay-layer').innerHTML = '';
            
            if (tab === 'reveal') {
                if(pdfBytes) scanForTreasure();
                else updateScanStatus("No atlas loaded.");
            } else {
                drawAllTempSpots();
            }
        }

        function updateScanStatus(msg, isError = false) {
            const el = document.getElementById('scan-status');
            if (!el) return;
            el.innerHTML = isError 
                ? `<span class="text-red-400"><i class="fas fa-exclamation-triangle"></i> ${msg}</span>` 
                : `<span class="text-[#38bdf8]"><i class="fas fa-radar"></i> ${msg}</span>`;
            el.classList.remove('hidden');
        }

        function openModal(src) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-img');
            img.src = src;
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('image-modal').classList.remove('active');
        }

        // File input styling update
        document.getElementById('treasure-file').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : "Choose File...";
            document.getElementById('attach-label').innerText = fileName;
            document.getElementById('attach-label').classList.toggle('text-[#38bdf8]', !!e.target.files[0]);
        });

        function processFile(file) {
            return new Promise((resolve, reject) => {
                if (file.size > 20 * 1024 * 1024) return reject("File too large (Max 20MB)");

                if (file.type.startsWith('audio/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ type: 'audio', data: e.target.result });
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_SIZE = 1200; 
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                            } else {
                                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve({ type: 'image', data: canvas.toDataURL('image/jpeg', 0.8) });
                        };
                        img.onerror = () => reject("Image load failed");
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => resolve({ type: 'file', data: e.target.result, name: file.name });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function scrambleBytes(bytes, key) {
            const res = new Uint8Array(bytes.length);
            const safeKey = key % 255; 
            for (let i = 0; i < bytes.length; i++) res[i] = bytes[i] ^ safeKey;
            return res;
        }

        async function renderPdf(data) {
            try {
                if (typeof pdfjsLib === 'undefined') throw new Error("PDF.js library missing");
                const canvas = document.getElementById('pdf-canvas');
                const context = canvas.getContext('2d');
                const loadingTask = pdfjsLib.getDocument({data: data});
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({scale: 1.5});
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({canvasContext: context, viewport: viewport}).promise;
            } catch (err) { console.error(err); }
        }

        async function addTreasurePoint() {
            const msgInput = document.getElementById('secret-message');
            const keyInput = document.getElementById('bake-key');
            const fileInput = document.getElementById('treasure-file');
            
            const msg = msgInput.value;
            const key = parseInt(keyInput.value);

            if (selectedX === 0) return alert("Select a location on the map first.");
            if ((!msg && !fileInput.files[0]) || isNaN(key)) return alert("Message/File and PIN required.");
            
            let artifact = { type: null, data: null, name: null };
            if (fileInput.files[0]) {
                try {
                    artifact = await processFile(fileInput.files[0]);
                } catch(e) {
                    return alert("Artifact Error: " + e);
                }
            }

            const pointData = { x: selectedX, y: selectedY, m: msg, k: key };
            if (artifact.type === 'image') pointData.i = artifact.data;
            if (artifact.type === 'audio') pointData.a = artifact.data;
            if (artifact.type === 'file') { pointData.f = artifact.data; pointData.n = artifact.name; }

            tempPoints.push(pointData);
            updateTreasureList();
            msgInput.value = '';
            fileInput.value = '';
            document.getElementById('attach-label').innerText = "Choose File...";
            document.getElementById('attach-label').classList.remove('text-[#38bdf8]');
            selectedX = 0; selectedY = 0;
            drawAllTempSpots();
            msgInput.focus();
        }

        function updateTreasureList() {
            const list = document.getElementById('treasure-list');
            document.getElementById('count-display').innerText = `${tempPoints.length} ITEMS`;
            if (tempPoints.length === 0) {
                list.innerHTML = '<div class="text-center text-[0.65rem] text-slate-600 italic py-8">No sigils placed yet.</div>';
                return;
            }
            list.innerHTML = '';
            tempPoints.forEach((p, idx) => {
                const item = document.createElement('div');
                item.className = "log-item";
                let icon = '';
                if (p.i) icon = '<i class="fas fa-image" title="Image"></i>';
                else if (p.a) icon = '<i class="fas fa-waveform" title="Audio"></i>';
                else if (p.f) icon = '<i class="fas fa-file-code" title="File"></i>';
                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-[#38bdf8] font-bold">#${(idx+1).toString().padStart(2,'0')}</span>
                        <span class="truncate max-w-[120px]">${p.m || 'Artifact'}</span>
                        <span class="text-slate-500 text-[10px]">${icon}</span>
                    </div>
                    <button onclick="removePoint(${idx})" class="text-slate-600 hover:text-red-400 px-2"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(item);
            });
            drawAllTempSpots();
        }

        function removePoint(idx) { tempPoints.splice(idx, 1); updateTreasureList(); }

        function drawAllTempSpots() {
            const layer = document.getElementById('overlay-layer');
            layer.innerHTML = '';
            tempPoints.forEach(p => {
                const spot = document.createElement('div');
                spot.className = "treasure-spot";
                spot.style.left = `${p.x * 100}%`;
                spot.style.top = `${p.y * 100}%`;
                layer.appendChild(spot);
            });
            if (selectedX !== 0 && selectedY !== 0) {
                const tempSpot = document.createElement('div');
                tempSpot.className = "treasure-spot";
                tempSpot.style.left = `${selectedX * 100}%`;
                tempSpot.style.top = `${selectedY * 100}%`;
                tempSpot.style.opacity = "0.6";
                tempSpot.style.animation = "pulse 1.5s infinite";
                layer.appendChild(tempSpot);
            }
        }

        async function bakeTreasure(btn) {
            if (!pdfBytes) return alert("No Source Document loaded.");
            if (tempPoints.length === 0) return alert("No Enigmas to conceal.");

            const originalText = btn.innerText;
            try {
                btn.innerText = "ENCRYPTING...";
                btn.classList.add('processing');
                await new Promise(r => setTimeout(r, 50));

                if (typeof window.PDFLib === 'undefined') throw new Error("PDF-Lib missing.");
                const { PDFDocument } = window.PDFLib;
                const doc = await PDFDocument.load(pdfBytes.slice(0));
                doc.setSubject(""); 
                const cleanPdfBytes = await doc.save();

                const payloadArray = tempPoints.map(p => {
                    const jsonStr = JSON.stringify({ m: p.m, x: p.x, y: p.y, i: p.i, a: p.a, f: p.f, n: p.n });
                    const utf8Bytes = new TextEncoder().encode(jsonStr);
                    const scrambled = scrambleBytes(utf8Bytes, p.k);
                    const binString = uint8ToBinaryString(scrambled);
                    return btoa(binString);
                });

                const finalPayloadJSON = JSON.stringify(payloadArray);
                const finalPayloadBytes = new TextEncoder().encode(finalPayloadJSON);
                const separatorBytes = new TextEncoder().encode(PAYLOAD_SEPARATOR);
                
                const finalFileBytes = new Uint8Array(cleanPdfBytes.length + separatorBytes.length + finalPayloadBytes.length);
                finalFileBytes.set(cleanPdfBytes, 0);
                finalFileBytes.set(separatorBytes, cleanPdfBytes.length);
                finalFileBytes.set(finalPayloadBytes, cleanPdfBytes.length + separatorBytes.length);

                const blob = new Blob([finalFileBytes], {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const safeName = document.getElementById('file-name').innerText.split('\n')[0].replace(/[^\w\s.-]/g, '');
                link.download = `CIPHER_ATLAS_${safeName || 'DOC'}_SECURED.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                pdfBytes = finalFileBytes;
                await renderPdf(pdfBytes.slice(0)); 
                await scanForTreasure(); 

                tempPoints = [];
                selectedX = 0; selectedY = 0;
                updateTreasureList();

                alert("Atlas Secured.");
                setTab('reveal');

            } catch (err) { alert("Encryption Error: " + err.message); }
            finally { btn.innerText = originalText; btn.classList.remove('processing'); }
        }

        async function scanForTreasure() {
            if (!pdfBytes) return;
            bakedDataArray = [];
            try {
                const separatorBytes = new TextEncoder().encode(PAYLOAD_SEPARATOR);
                const fileLen = pdfBytes.length;
                const sepLen = separatorBytes.length;
                let foundIdx = -1;
                const scanLimit = Math.max(0, fileLen - 50 * 1024 * 1024);
                
                for (let i = fileLen - sepLen; i >= scanLimit; i--) {
                    if (pdfBytes[i] === separatorBytes[0]) {
                        let match = true;
                        for (let j = 1; j < sepLen; j++) {
                            if (pdfBytes[i+j] !== separatorBytes[j]) { match = false; break; }
                        }
                        if (match) { foundIdx = i; break; }
                    }
                }

                if (foundIdx !== -1) {
                    const payloadBytes = pdfBytes.slice(foundIdx + sepLen);
                    const payloadStr = new TextDecoder().decode(payloadBytes);
                    bakedDataArray = JSON.parse(payloadStr);
                    updateScanStatus(`Detected: ${bakedDataArray.length} Sigils.`);
                } else {
                     // Check for legacy versions if needed
                     const oldSep = "%%ENIGMA_ARCHIVES_PAYLOAD_V1%%"; 
                     // Simple fallback check
                     if(pdfBytes.length > 100) updateScanStatus("No hidden sigils found.", true);
                }
            } catch (err) { updateScanStatus("Scan Error.", true); }
        }

        function checkTreasureClick(cx, cy) {
            if (bakedDataArray.length === 0) return;
            const keyVal = document.getElementById('reveal-key').value;
            if (!keyVal) return alert("Decryption PIN Required.");
            const key = parseInt(keyVal);
            let found = false;

            bakedDataArray.forEach(encoded => {
                try {
                    const binString = atob(encoded);
                    const scrambled = new Uint8Array(binString.length);
                    for (let i = 0; i < binString.length; i++) scrambled[i] = binString.charCodeAt(i);
                    const utf8Bytes = scrambleBytes(scrambled, key);
                    const decryptedJson = new TextDecoder().decode(utf8Bytes);
                    const data = JSON.parse(decryptedJson);

                    if (Math.abs(data.x - cx) < 0.1 && Math.abs(data.y - cy) < 0.1) {
                        const layer = document.getElementById('overlay-layer');
                        const treasureDiv = document.createElement('div');
                        treasureDiv.style.position = 'absolute';
                        treasureDiv.style.left = `${data.x * 100}%`;
                        treasureDiv.style.top = `${data.y * 100}%`;
                        
                        treasureDiv.onmousedown = function() { this.querySelector('.revealed-msg').style.zIndex = ++globalZIndex; };

                        // Dynamic positioning classes
                        let posClass = '';
                        if (data.x < 0.2) posClass += ' msg-left';
                        else if (data.x > 0.8) posClass += ' msg-right';
                        if (data.y < 0.3) posClass += ' msg-bottom';
                        
                        let contentHtml = '';
                        if (data.i) {
                            contentHtml = `
                                <div class="relative group mt-2">
                                    <img src="${data.i}" onclick="openModal('${data.i}')" alt="Artifact">
                                    <a href="${data.i}" download="atlas_artifact.jpg" class="absolute bottom-2 right-2 bg-slate-900/80 text-[#38bdf8] w-8 h-8 flex items-center justify-center rounded hover:bg-[#38bdf8] hover:text-slate-900 transition-colors" onclick="event.stopPropagation();">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            `;
                        } else if (data.a) {
                            contentHtml = `<audio controls src="${data.a}" class="w-full mt-3 h-8 invert"></audio>`;
                        } else if (data.f) {
                            contentHtml = `
                                <div class="mt-3 bg-slate-800/50 border border-slate-700 p-2 rounded flex justify-between items-center">
                                    <span class="text-[0.65rem] text-slate-300 font-mono truncate max-w-[150px]">${data.n || 'classified_doc'}</span>
                                    <a href="${data.f}" download="${data.n || 'file'}" class="text-[0.65rem] text-[#38bdf8] font-bold border border-[#38bdf8] px-2 py-1 rounded hover:bg-[#38bdf8] hover:text-slate-900 transition-colors">GET</a>
                                </div>`;
                        }
                        
                        treasureDiv.innerHTML = `
                            <div class="treasure-spot"></div>
                            <div class="revealed-msg ${posClass}">
                                <div class="flex justify-between items-start border-b border-slate-700 pb-2 mb-2">
                                    <div class="text-[#38bdf8] font-bold font-mono text-sm" style="text-shadow: 0 0 10px rgba(56,189,248,0.5);"><i class="fas fa-eye"></i> DECLASSIFIED</div>
                                    <button class="text-slate-400 hover:text-white" onclick="this.closest('.revealed-msg').parentElement.remove();">Ã—</button>
                                </div>
                                <div class="text-white font-medium font-sans leading-snug tracking-wide" style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${data.m || ''}</div>
                                ${contentHtml}
                            </div>
                        `;
                        layer.appendChild(treasureDiv);
                        found = true;
                    }
                } catch (err) {}
            });
        }

        function uint8ToBinaryString(bytes) {
            let binary = '';
            const CHUNK_SIZE = 8192; 
            for (let i = 0; i < bytes.length; i += CHUNK_SIZE) {
                binary += String.fromCharCode.apply(null, bytes.subarray(i, Math.min(i + CHUNK_SIZE, bytes.length)));
            }
            return binary;
        }

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('pdf-input');

        function handleFile(file) {
            if (!file) return;
            document.getElementById('file-name').innerHTML = `Reading...<br>${file.name}`;
            document.getElementById('empty-state').style.display = 'none';
            const reader = new FileReader();
            reader.onload = async function() {
                pdfBytes = new Uint8Array(reader.result);
                await renderPdf(pdfBytes.slice(0)); 
                document.getElementById('file-name').innerHTML = `${file.name}<br>Click to Change`;
                if (currentTab === 'reveal') scanForTreasure();
            };
            reader.readAsArrayBuffer(file);
        }

        fileInput.onchange = (e) => handleFile(e.target.files[0]);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drag-over');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); };

        document.getElementById('pdf-canvas').onclick = async (e) => {
            const rect = e.target.getBoundingClientRect();
            const clickX = (e.clientX - rect.left) / rect.width;
            const clickY = (e.clientY - rect.top) / rect.height;
            if (currentTab === 'bake') {
                const isQuick = document.getElementById('quick-mode').checked;
                selectedX = clickX; selectedY = clickY;
                if (isQuick && (document.getElementById('secret-message').value || document.getElementById('treasure-file').files[0]) && document.getElementById('bake-key').value) await addTreasurePoint();
                else drawAllTempSpots();
            } else { 
                checkTreasureClick(clickX, clickY); 
            }
        };
    </script>
</body>
</html>